Review Response and Recommended Action
=======================================

Date: 2026-01-07
Reviewer: Claude Code Review Agent
PR: #2 - Fix structlog event argument conflict

Edge Case Identified
--------------------
The reviewer identified that **extra parameters in logging functions could
reintroduce the "event" key conflict:

    event_data.update(extra)  # If extra contains {"event": "..."}, bug returns

Example vulnerable call:
    log_auth_attempt(logger, method="jwt", success=False, event="custom_event")

This would reintroduce:
    TypeError: got multiple values for argument 'event'

Recommended Action
------------------
FIX NOW in this PR.

Rationale:
1. Simple fix - one line addition per function (5 total)
2. Defensive programming - prevents regression via user input
3. Consistency - we're fixing the root cause, not just one symptom
4. Already in context - we're touching this exact code
5. Low risk - filtering a reserved key is safe

Proposed Fix
------------
After each `event_data.update(extra)` call, add:

    event_data.pop("event", None)

Or preemptively filter before update:

    safe_extra = {k: v for k, v in extra.items() if k != "event"}
    event_data.update(safe_extra)

Affected Locations (5):
- log_auth_attempt: line 127
- log_permission_check: line 159
- log_token_validation: line 195
- log_cache_operation: line 226
- log_error: line 250

Additional Test Required
------------------------
Add test case to verify **extra with "event" key doesn't cause TypeError:

    def test_extra_event_key_filtered(self, mock_logger):
        """Test that 'event' in extra kwargs is filtered out."""
        log_auth_attempt(
            mock_logger,
            method="jwt",
            success=True,
            event="should_be_filtered",  # This should not cause conflict
        )
        call_kwargs = mock_logger.info.call_args[1]
        assert "event" not in call_kwargs

Verdict
-------
Address the edge case in this PR before merging. Estimated effort: 15 minutes.
This ensures a complete fix rather than a partial one.
