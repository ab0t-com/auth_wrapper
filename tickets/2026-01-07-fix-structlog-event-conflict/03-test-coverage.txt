Test Coverage for Structlog Event Argument Conflict Fix
========================================================

Date: 2026-01-07
Branch: fix/structlog-event-conflict

New Test File
-------------
tests/test_logging.py - 56 tests covering the ab0t_auth.logging module

Test Categories
---------------

1. AuthEvent Tests (3 tests)
   - test_create_auth_event
   - test_auth_event_with_all_fields
   - test_auth_event_immutable

2. Log Function Tests - Event Type Key (23 tests)
   These tests verify the bug fix by checking that "event_type" is used
   instead of "event" in all logging functions:

   TestLogAuthAttempt (5 tests):
   - test_success_logs_info
   - test_failure_logs_warning
   - test_no_event_key_conflict  <-- Core bug fix test
   - test_with_duration
   - test_with_extra_fields

   TestLogPermissionCheck (4 tests):
   - test_allowed_logs_debug
   - test_denied_logs_info
   - test_no_event_key_conflict  <-- Core bug fix test
   - test_with_duration

   TestLogTokenValidation (4 tests):
   - test_valid_logs_debug
   - test_invalid_logs_warning
   - test_no_event_key_conflict  <-- Core bug fix test
   - test_cached_flag

   TestLogCacheOperation (5 tests):
   - test_cache_hit
   - test_cache_miss
   - test_no_event_key_conflict  <-- Core bug fix test
   - test_key_truncation
   - test_short_key_not_truncated

   TestLogError (5 tests):
   - test_logs_error_level
   - test_no_event_key_conflict  <-- Core bug fix test
   - test_captures_error_type
   - test_with_context
   - test_includes_exc_info

3. Integration Tests - Regression Prevention (8 tests)
   These tests use real structlog to ensure no TypeError is raised:

   - test_log_auth_attempt_no_typeerror
   - test_log_auth_attempt_success_no_typeerror
   - test_log_permission_check_no_typeerror
   - test_log_permission_check_allowed_no_typeerror
   - test_log_token_validation_no_typeerror
   - test_log_token_validation_valid_no_typeerror
   - test_log_cache_operation_no_typeerror
   - test_log_error_no_typeerror

4. Timer Tests (4 tests)
   - test_timer_basic
   - test_timer_context_manager
   - test_timer_not_started
   - test_timer_running

5. AuthMetrics Tests (8 tests)
   - test_record_auth_attempt_success
   - test_record_auth_attempt_failure
   - test_record_permission_check
   - test_record_cache_access
   - test_cache_hit_rate
   - test_cache_hit_rate_no_accesses
   - test_auth_success_rate
   - test_to_dict

6. Context Variable Tests (4 tests)
   - test_request_id_default
   - test_user_id_default
   - test_request_id_set_get
   - test_user_id_set_get

7. Configuration Tests (5 tests)
   - test_configure_json_format
   - test_configure_console_format
   - test_configure_without_timestamp
   - test_get_logger_default_name
   - test_get_logger_custom_name

8. Timed Factory Test (1 test)
   - test_timed_returns_timer

Test Run Results
----------------
Command: .venv/bin/python -m pytest tests/ -v --tb=short
Result: 203 passed in 0.36s
  - Original tests: 147 passed
  - New logging tests: 56 passed

Key Bug Fix Tests
-----------------
The following tests specifically verify the bug fix by asserting that
"event_type" is used instead of "event" in the event_data dictionary:

1. TestLogAuthAttempt::test_no_event_key_conflict
2. TestLogPermissionCheck::test_no_event_key_conflict
3. TestLogTokenValidation::test_no_event_key_conflict
4. TestLogCacheOperation::test_no_event_key_conflict
5. TestLogError::test_no_event_key_conflict

Each of these tests:
- Calls the logging function
- Verifies "event_type" is present in kwargs
- Verifies "event" is NOT present in kwargs

The integration tests then verify that calling these functions with a real
structlog logger does not raise TypeError.
